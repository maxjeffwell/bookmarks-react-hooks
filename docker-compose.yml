  version: '3.8'

  services:
    # React Client
    client:
      build:
        context: .
        dockerfile: Dockerfile
        target: production
        args:
          REACT_APP_API_BASE_URL: ${REACT_APP_API_BASE_URL:-/api}
      container_name: bookmarks-client
      environment:
        - NODE_ENV=${NODE_ENV:-production}
      ports:
        - "${CLIENT_PORT:-3000}:80"
      networks:
        - bookmarks-network
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
        interval: 30s
        timeout: 3s
        start_period: 20s
        retries: 3

    # Express Server (Optional - for local development alternative to Vercel functions)
    server:
      build:
        context: ./server
        dockerfile: Dockerfile
        target: production
      container_name: bookmarks-server
      environment:
        - NODE_ENV=${NODE_ENV:-production}
        - PORT=${SERVER_PORT:-3001}
        - DATABASE_URL=${DATABASE_URL}
        - OPENAI_API_KEY=${OPENAI_API_KEY}
        - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
        - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.3}
        - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-500}
        - AI_FEATURES_ENABLED=${AI_FEATURES_ENABLED:-true}
        - AI_CACHE_ENABLED=${AI_CACHE_ENABLED:-true}
      ports:
        - "${SERVER_PORT:-3001}:3001"
      networks:
        - bookmarks-network
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3001/api/bookmarks', (r) =>
  {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
        interval: 30s
        timeout: 3s
        start_period: 10s
        retries: 3
      profiles:
        - with-server

  networks:
    bookmarks-network:
      driver: bridge

